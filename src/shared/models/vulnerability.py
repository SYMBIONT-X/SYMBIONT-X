"""Vulnerability data model."""

from datetime import datetime
from enum import Enum
from typing import Optional
from pydantic import BaseModel, Field


class Severity(str, Enum):
    """Vulnerability severity levels."""
    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"
    UNKNOWN = "unknown"


class VulnerabilityStatus(str, Enum):
    """Vulnerability lifecycle status."""
    DETECTED = "detected"
    ASSESSING = "assessing"
    PLANNING = "planning"
    REMEDIATING = "remediating"
    PENDING_APPROVAL = "pending_approval"
    RESOLVED = "resolved"
    IGNORED = "ignored"


class Vulnerability(BaseModel):
    """Represents a security vulnerability."""
    
    id: str = Field(..., description="Unique vulnerability identifier")
    cve_id: Optional[str] = Field(None, description="CVE identifier if available")
    title: str = Field(..., description="Short vulnerability title")
    description: str = Field(..., description="Detailed description")
    severity: Severity = Field(..., description="Severity level")
    cvss_score: Optional[float] = Field(None, ge=0.0, le=10.0, description="CVSS score")
    
    # Affected component
    package_name: Optional[str] = Field(None, description="Affected package name")
    package_version: Optional[str] = Field(None, description="Affected version")
    file_path: Optional[str] = Field(None, description="File path where found")
    line_number: Optional[int] = Field(None, description="Line number if applicable")
    
    # Fix information
    fixed_version: Optional[str] = Field(None, description="Version with fix")
    fix_recommendation: Optional[str] = Field(None, description="How to fix")
    
    # Metadata
    status: VulnerabilityStatus = Field(default=VulnerabilityStatus.DETECTED)
    source: str = Field(..., description="Scanner that detected this")
    repository: Optional[str] = Field(None, description="Repository name")
    branch: Optional[str] = Field(None, description="Git branch")
    commit_sha: Optional[str] = Field(None, description="Git commit SHA")
    
    # Timestamps
    detected_at: datetime = Field(default_factory=datetime.utcnow)
    updated_at: datetime = Field(default_factory=datetime.utcnow)
    
    class Config:
        use_enum_values = True
        
    def to_priority(self) -> str:
        """Calculate initial priority based on severity."""
        priority_map = {
            Severity.CRITICAL: "P0",
            Severity.HIGH: "P1",
            Severity.MEDIUM: "P2",
            Severity.LOW: "P3",
            Severity.UNKNOWN: "P3",
        }
        return priority_map.get(self.severity, "P3")
